# SPDX-FileCopyrightText: © 2024 Alexander Kromm <mmaulwurff@gmail.com>
# SPDX-License-Identifier: CC0-1.0
:properties:
:header-args: :comments no :mkdirp yes :noweb yes :results none
:end:
#+title: TestRunner

* License
[[file:LICENSES/CC0-1.0.txt][CC0-1.0]]
#+name: CC
#+begin_src :exports none
SPDX-FileTextCopyright: © 2024 Alexander Kromm <mmaulwurff@gmail.com>
SPDX-License-Identifier: CC0-1.0
#+end_src

#+begin_src elisp :tangle build/TestRunner/dt-scripts.el
;; <<CC>>
#+end_src
#+begin_src ini :tangle build/TestRunner/config.ini
# <<CC>>
#+end_src

* Config
Minimal config for testing purposes.

#+begin_src ini :tangle build/TestRunner/config.ini
[GlobalSettings]
autoloadwidescreen=false
developer=1
gl_texture_filter=6
m_simpleoptions=false
showendoom=0

[Doom.ConsoleAliases]
Name=save-load
Command=save save; wait 3 ; load save

[Doom.ConsoleVariables]
m_quickexit=true
vid_cursor=cursor
wipetype=0
#+end_src

* Launch script
Environment:
- ~CLEMATIS_PATH~: path to Clematis directory, example: ~"/home/user/src/clematis/src"~
- ~IWAD_PATH~: path to an IWAD, example: ~"/home/user/src/miniwad/miniwad.wad"~

TODO: ~sed 's/Script error, \"\(.*\)\/:\(.*\)\" line \(.*\)/\1\/\2:\3/')"~
TODO: filter uninteresting GZDoom output lines.
TODO: replace shell command with direct call?

#+begin_src elisp :tangle build/TestRunner/dt-scripts.el
(defun run-tests (mod-path command)
  (org-babel-tangle)
  (shell-command (concat "gzdoom"
                         " -noautoload"
                         " -nosound"
                         " -config build/TestRunner/config.ini"
                         " -iwad " (getenv "IWAD_PATH")
                         " -file " (getenv "CLEMATIS_PATH") " " mod-path
                         " +\"" command "\"")))
#+end_src

Example:
#+begin_src elisp
(load-file "build/TestRunner/dt-scripts.el")
(run-tests "build/SomeMod" "wait 1; quit")
#+end_src
